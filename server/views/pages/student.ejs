<!DOCTYPE html>
<html lang="en">
<head>
	<% include ../partials/head %>
</head>
<body onload="initSketch()">
	<script type="text/javascript">
		console.log("inside scrupt");
		// init self id
		window.SELF_EASY_ID = "";

		function resetLocalStorageKeys(keys){
			keys.forEach(function(key, index){
				localStorage.removeItem(key);
			});
		}

		easyrtc.setStreamAcceptor(function(easyrtcId, stream){
			var audio = $("#callerAudio");
			easyrtc.setVideoObjectSrc(audio, stream);
		});

		//TTK: create just one room which can embed many applications
		// in this case, on lecture(created by lecturer)per application
		// ** above is other way round I think **

		// useful functions from doc, i think:
		// appObj.createRoom
		// enableDataChannel, sendPeerMessage, sendServerMessage, sendData, 
		// setApplicationName, sendDataP2P, joinRoom, setPeerListener, 
		// setServerListener, setUsername
		// supportsGetUserMedia, supportsPeerConnections
		// setCookieId, setCredential, setOnCall, setOnHangup
		// setRoomApiField: can be used to set variables, and can be listed on
		// setRoomOccupantListener, setSocketUrl

		function openSketchModal(){

		}

		// function called when student connects successfully
		function loginSuccess(easyrtcId){
			resetLocalStorageKeys(Array("SELF_ID"));
			localStorage.setItem("SELF_ID", easyrtcId);

			// hide connect button and form 
			$("#connect-container").css({display: "none"});

			// get rooms in application
			getRooms();
		}

		// function called when student's attempt to connect fails
		function loginFailure(errorCode, message){
			easyrtc.showError(errorCode, message);
		}

		function sendCallerInfoSuccess(msgType, msgBody){
	  		console.log("call request message was sent ", msgType, msgBody);
	  	}
		function sendCallerInfoFailure(errorCode, errorText){
		  console.log("error sending call request info ", errorText);
		}

		function callLecturerSuccess(otherCaller, mediaType){
			console.log("call req SUCCESS");

			// create and enable sketch button which enables a modal on click
			var button = $('<button/>', {
        		text: "Sketch", //set text 1 to 10
        		class: "btn btn-sm btn-primary",
        		id: "sketch-button-" + roomName,
        		click: function () { openSketchModal(); }
    		});
    		// set modal call attributes
    		button.attr("data-toggle", "modal");
    		button.attr("data-target", "#sketch-modal");
			$("#room-article-"+ roomName +  " div:last-child span#call-btn-span").after(button);
		}

		function callLecturerFailure(errorCode, errorText){
			console.log("call req FAILURE");
		}	

		function callLecturerAccepted(accepted, caller){
			console.log("INSIDE CALL ACCEPTED");
			easyrtc.hangupAll();
			if( !accepted ) {
            	easyrtc.showError("CALL-REJECTED", "Sorry, your call to " + easyrtc.idToName(caller) + " was rejected");
            	enable('otherClients');
        	}
		}

		function makeCallToLecturer(roomName){
			// send to lecturer event "call_request", then make call
			//easyrtc.sendPeerMessage(localStorage.getItem("LECTURER_ID"), "call_request", {callerId: localStorage.getItem("SELF_ID")}, 
	  	  	//	sendCallerInfoSuccess, sendCallerInfoFailure);
			//easyrtc.call(localStorage.getItem("LECTURER_ID"), 
			//	callLecturerSuccess, callLecturerFailure, callLecturerAccepted);
			var rsltArr = easyrtc.usernameToIds("Lecturer");
			console.log("LECTURER ID ", rsltArr);
			easyrtc.call(rsltArr[0].easyrtcid, callLecturerSuccess, 
				callLecturerFailure, callLecturerAccepted);
		}

		function roomJoinSuccess(roomName){
			console.log("you have joined room " + roomName);
		}

		function roomJoinFailure(errorCode, errorText){
			alert("you could not join the room");
		}
		// handle when join button is clicked
		// send request to lecturer
		function handleJoinClick(eventData){
			var roomName = eventData.data;
			console.log("HANDLE JOIN CLICK: roomname, ", roomName);
			easyrtc.joinRoom(roomName, null, roomJoinSuccess, roomJoinFailure);


			// create call button dynamically 
			var button = $('<button/>', {
        		text: "Call", //set text 1 to 10
        		class: "btn btn-sm btn-default",
        		id: "call-button-" + roomName,
        		click: function () { makeCallToLecturer(roomName); }
    		});
			$("#room-article-"+ roomName +  " div:last-child span#call-btn-span").after(button);
		}

		function getRoomListSuccess(roomList){
			// now list rooms in view
			$(".sponsor-content-bg").css({"display":"block", marginTop: "-100px"});
			console.log("roomLust", roomList);
          	var rooms = $("#rooms");
          	rooms.innerHTML = '';
          	//  clone copies if more than 1
          	var roomsContainer;
      		//$("#room-article").css({display: "block"});
      		// show no rooms message if none available
      		if(Object.keys(roomList).length < 1){
      			$("#no-room").css({display: "block"});
      		} else {
      			$("#room-article").css({display: "block"});

	      		var count = 0;
	      		var previousArticle;
	      		for(roomName in roomList){
	      			if(count === 0){
	      				// match the button and add listener
	      				$("#room-article div:last-child button").click(roomName, handleJoinClick);
	      				count += 1;
	      			} else {
	      				var roomArticle = $("#room-article").clone(false); // dont add event handlers
	      				// change id to match, then add click listener to button
	      				roomArticle.attr("id", "room-article-" + roomName);
	      				previousArticle = $("#room-article-"+roomName);
	      				
	      				var query = "#" + roomArticle.attr("id") + " div:last-child button";
	      				console.log("DIDNT MATHC? ", query, $(query));
	      				$("#rooms-list-container").append(roomArticle);
	      				// added after append, to take effect
	      				$(query).click(roomName, handleJoinClick);
	      				count += 1;
	      			}
	      		}
	          	
	          	// assign room names to blocks
	          	var count = 0;
			  	for(roomName in roomList) {
		  			$(".room-name").each(function(i){
	        			if(i === count){
	        				console.log("SETTING ROOM NAME: ", roomName)
	        				$(this).text(roomName);
	        			}
	        		});
	        		count += 1;
	          	}
      		}
      		
      		
		}

		function getRoomListFailure(errorCode, errorText){
			console.log("failed getting room list ", errorText);
		}

		function seeOtherDisabledStudents(roomName, occupants, isPrimary){
			var otherStudents = document.getElementById("other-students");
			occupants.forEach(function(occupant, index){
				// TODO: make disabled
				otherStudents.append("<li>" + occupant + "</li>")
			});
		}

		function makeCallRequest(lecturerId){
			// TODO: obtain lecturer Ã­d
		}
		// using recursion to halt till user is connected to server
		function getRooms(){
			easyrtc.getRoomList(getRoomListSuccess, getRoomListFailure);	
		}

		function roomOwnerListener(easyrtcId, msgType, msgData, targeting){
			console.log("ROOM OWNER event received: ", msgType, msgData, targeting);
			// set gloabal lecturer easyrtcid
			localStorage.setItem("LECTURER_ID", easyrtcId);
		}

		function connect(){
			console.log("connect clicked");
			// audio only
			easyrtc.enableVideo(false);
    		easyrtc.enableVideoReceive(false);
    		easyrtc.enableDebug(true);
    		// listen for whenever room_owner message is received
    		easyrtc.setPeerListener(roomOwnerListener, "room_owner");

    		// commented out because we don't care about other students in the room for now
    		//easyrtc.setRoomOccupantListener(convertListToButtons);
    		easyrtc.initMediaSource(
        		function(){        // success callback
            		easyrtc.connect("easyrtc.AskAloud", loginSuccess, loginFailure);
        		},
       	 		function(errorCode, errmesg){
            		easyrtc.showError(errorCode, errmesg);
        		}	// failure callback
        	);
        	if ( !easyrtc.setUsername($("#username").val()) ){
       			alert("bad user name");
       			easyrtc.disconnect();
       		}
		}

		function connectAndRequest(){
			connect();
		};


	</script>
	<header>
		<% include ../partials/header %>
	</header>
	

	<main style="min-height:600px;padding-top:150px;" class="container">

		<video id="callerAudio"></video>

		<div class="connect-btn" id="connect-container">
			<div class="form-group">
    			<label for="username">Username</label>
    			<input type="text" class="form-control" id="username" placeholder="Enter username (one word)">
  			</div>
			<button id="connect-btn" onclick="connectAndRequest()" class="btn btn-primary">Connect</button>
		</div>
		<button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#sketch-modal">
  			Open Modal
		</button>

		<div class="sponsor-content-bg">
    	  <div class="container">
        	<div class="content-col-container" id="content-col-container">
              <div class="content-header">
                <h4> Current Rooms</h4>
                <div id="no-room">
                	No Rooms Available
                </div>
              </div>
              <div class="container" id="rooms-list-container">
              	<div class="event-article col-md-3" style="margin-left: 20px;" id="room-article">
                    <div class="event-article-header red-header">
                        <h5>Category</h5>
                    </div>
                    <div class="event-article-img">
                        <img src="assets/images/default.png" alt=""/>
                    </div>
                    <div class="event-article-title">
                        <h4 class="room-name"> Room Name Goes Here</h4>
                    </div>
                    <div class="event-article-content">
                        <p>
                            Some random words to make you join this room
                            Furthermore, we really need you to come in your numbers
                        </p>
                    </div>
                    <div class="event-article-extras">
                        <button class="btn btn-sm btn-default join-btn" id="">
                            <span class="glyphicon glyphicon-plus"></span>
                            Join
                        </button>
                        <span class="pull-right event-call-container" id="call-btn-span">
                            <!--  <button class="btn btn-sm btn-default" id="">
                                 <span class="glyphicon glyphicon-share"></span>
                                 Call
                             </button> -->
                             
                        </span>
                    </div>
                </div>
              </div>
            </div>
          </div>
        </div>


	</main>

	<!-- Modal -->
	<div class="modal fade" id="sketch-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" style="margin-top:60px;">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	        <h4 class="modal-title" id="myModalLabel">Sketch</h4>
	      </div>
	      <div class="modal-body">
	        <div class="container">
				<div class="tools-container">
					Choose Color
					<ul class="color-box-list">
						<li class="color-box" id="green" onclick="color(this)"></li>
						<li class="color-box" id="blue" onclick="color(this)"></li>
						<li class="color-box" id="red" onclick="color(this)"></li>
				        <li class="color-box" id="yellow" onclick="color(this)"></li>
				        <li class="color-box" id="orange" onclick="color(this)"></li>
				        <li class="color-box" id="black" onclick="color(this)"></li>
					</ul>
				</div>
		
				<div class="tools-container">
					Eraser
					<ul class="color-box-list">
						<li class="color-box" id="white" onclick="color(this)"></li>
					</ul>
				</div>

				<canvas id="can" width="500" height="400"></canvas>

				<div class="form-group">
					<button id="btn" onclick="save()" class="btn btn-primary">Save</button>
		        	<button id="clr" onclick="erase()" class="btn btn-default">Clear</button>	
				</div>
		
	  		</div>
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	        <button type="button" class="btn btn-primary">Save changes</button>
	      </div>
	    </div>
	  </div>
	</div>

	<footer>
		<% include ../partials/footer %>
	</footer>

</body>

</html>