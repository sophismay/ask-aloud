<div class="container">
  <div class="row">
    <div class="col-lg-12">
      <h1 class="page-header">Existing Rooms:</h1>
      <ul class="nav nav-tabs nav-stacked col-md-4 col-lg-4 col-sm-6" ng-repeat="room in $ctrl.rooms">
        <li><a href="#" uib-tooltip="{{room.info}}">{{room.name}}<button type="button" class="close" ng-click="$ctrl.joinRoom(room)">&times;</button></a></li>
      </ul>
      <!-- begin listing rooms -->
      <div>
      <button onclick="connect()">Show Rooms</button>
      <ul id="rooms-list">

      </ul>
      </div>

    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/socket.io-client/socket.io.js"></script>
  <script type="text/javascript" src="assets/js/easyrtc.js"></script>
  <script type="text/javascript">
    var selfEasyrtcid = "";

    function disable(domId) {
        document.getElementById(domId).disabled = "disabled";
    }


    function enable(domId) {
        document.getElementById(domId).disabled = "";
    }

    function terminatePage() {
      easyrtc.disconnect();
    }


    function hangup() {
      easyrtc.hangupAll();
      disable('hangupButton');
    }


    function connect() {
        console.log("Initializing.");
        easyrtc.enableVideo(false);
        easyrtc.enableVideoReceive(false);
        easyrtc.setRoomOccupantListener(convertListToButtons);
        easyrtc.initMediaSource(
            function(){        // success callback
                easyrtc.connect("easyrtc.audioOnly", loginSuccess, loginFailure);
            },
            function(errorCode, errmesg){
                easyrtc.showError(errorCode, errmesg);
            }  // failure callback
            );
    }

    function convertListToButtons (roomName, occupants, isPrimary) {
        //clearConnectList();
        console.log('IN convertListToButtons: ROONNAME: ', roomName)
        var roomsList = document.getElementById('rooms-list');
        console.log('roomsList: ', roomsList)
        for(var easyrtcid in occupants) {
            var button = document.createElement('button');
            button.onclick = function(easyrtcid) {
                return function() {
                    performCall(easyrtcid);
                };
            }(easyrtcid);
            var listItem = document.createElement('li');
            console.log('listItem: ', listItem)
            var label = document.createElement('text');
            label.innerHTML = easyrtc.idToName(easyrtcid);
            button.appendChild(label);
            listItem.appendChild(button);
            roomsList.appendChild(listItem);
            console.log('at end of function convertListToButtons')
        }
    }

    function performCall(otherEasyrtcid) {
        easyrtc.hangupAll();
        var acceptedCB = function(accepted, caller) {
            if( !accepted ) {
                easyrtc.showError("CALL-REJECTED", "Sorry, your call to " + easyrtc.idToName(caller) + " was rejected");
                enable('otherClients');
            }
        };
        var successCB = function() {
            enable('hangupButton');
        };
        var failureCB = function() {
            enable('otherClients');
        };
        easyrtc.call(otherEasyrtcid, successCB, failureCB, acceptedCB);
    }


    function loginSuccess(easyrtcid) {
        disable("connectButton");
        // enable("disconnectButton");
        enable('otherClients');
        selfEasyrtcid = easyrtcid;
        document.getElementById("iam").innerHTML = "I am " + easyrtcid;
    }


    function loginFailure(errorCode, message) {
        easyrtc.showError(errorCode, message);
    }


    function disconnect() {
        document.getElementById("iam").innerHTML = "logged out";
        easyrtc.disconnect();
        console.log("disconnecting from server");
        enable("connectButton");
        // disable("disconnectButton");
        clearConnectList();
    }
  </script>

  <!-- <form class="thing-form">
    <label>Syncs in realtime across clients</label>
    <p class="input-group">
      <input type="text" class="form-control" placeholder="Add a new thing here." ng-model="$ctrl.newThing">
      <span class="input-group-btn">
        <button type="submit" class="btn btn-primary" ng-click="$ctrl.addThing()">Add New</button>
      </span>
    </p>
  </form> -->
</div>